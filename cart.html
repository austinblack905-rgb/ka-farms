<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cart – K&A Farms</title>
<script src="Products.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="shortcut icon" type="image/x-icon" src="assets/KA_logo.png">
<style>
:root {--bg:#faf8f6;--ink:#1f2937;--muted:#667085;--brand:#a18c00;--accent:#fffce8}
*{box-sizing:border-box} html,body{margin:0}
body{font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--ink)}
header{background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10}
.nav{max-width:1000px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.links{display:flex;align-items:center;gap:14px}
.links a{color:var(--ink);text-decoration:none;font-weight:600}
.links a:hover{color:var(--brand)}
.cartpill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #eee;border-radius:999px;background:#fff}
.cartpill b{min-width:2ch;display:inline-block;text-align:right}
.container{max-width:1000px;margin:0 auto;padding:28px 18px}
.h1{font-size:28px;font-weight:700;margin:0 0 10px}
.card{background:#fff;border:1px solid #eee;border-radius:16px}
.pad{padding:14px}
.row{display:grid;grid-template-columns:1.4fr .9fr .9fr .9fr .6fr;gap:12px;align-items:center}
@media (max-width:780px){.row{grid-template-columns:1.4fr .9fr .9fr 1fr}}
.head{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
.step{width:36px;height:36px;display:inline-flex;align-items:center;justify-content:center;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;font-size:18px}
.qty{min-width:2ch;text-align:center;font-weight:700}
.line{display:flex;align-items:center;gap:10px}
.thumb{width:56px;height:56px;border-radius:10px;border:1px solid #eee;object-fit:cover;background:#fff}
.money{font-weight:700}
.actions{display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:12px;border:1px solid var(--brand);background:#fff; color:var(--brand); font-weight:700;cursor:pointer}
.btn:hover {background:var(--brand); color:#fff;}
.btn.primary{background:var(--brand);color:#fff;border:1px solid var(--brand);}
.btn.primary:hover {background:#fff; color:var(--brand);}
.btn.danger{border-color:#b91c1c;background:#fff;color:#b91c1c}
.btn.danger:hover {background:#b91c1c; color:#fff;}
.btn.cashapp {background-color:#00CF31; color:#fff; border:1px solid #00CF31;}
.btn.cashapp:hover {background:#fff; color:#00CF31;}
.btn.venmo {background-color:#008cff; color:#fff; border:1px solid #008cff;}
.btn.venmo:hover {background:#fff; color:#008cff;}
.notice{padding:12px 14px;border:1px dashed #e5e7eb;border-radius:12px;background:#fff;color:var(--muted)}
.totals{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border:1px solid #eee;border-radius:12px;background:#fff;font-weight:700}
.grid2{display:grid;grid-template-columns:1fr 360px;gap:18px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
.empty{padding:20px;border:1px dashed #e5e7eb;border-radius:12px;background:#fff;text-align:center}
label{font-weight:700; font-size:14px}
input,select,textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#fff}
.small{font-size:12px;color:var(--muted)}
.code{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; background:#fff; border:1px solid #eee; border-radius:10px; padding:8px}
</style>

<!-- EmailJS (client-side mail) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  emailjs.init({ publicKey: "QFiL1qFBYY9GBGfIv" });
  const EMAILJS_SERVICE_ID  = "service_hzdpajb";
  const EMAILJS_TEMPLATE_ID = "template_3is7a8d";
</script>
</head>
<body>
<header>
  <div class="nav">
    <div style="display:flex;align-items:center;gap:10px">
      <a href="https://www.ka-farms.com" style="text-decoration:none;color:inherit"><strong>K&A Farms</strong></a>
    </div>
    <nav class="links">
      <a href="https://www.ka-farms.com/Shop">Shop</a>
      <a href="https://www.ka-farms.com/cart" class="cartpill" title="View cart">
        <span>Cart</span>
        <b id="cartCount">0</b>
        <span>· $<span id="cartTotal">0.00</span></span>
      </a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 class="h1">Your Cart</h1>
  <div id="cartBox"></div>

  <div class="grid2" style="margin-top:18px">
    <section>
      <div class="totals"><span>Order total</span><span>$ <span id="grand">0.00</span></span></div>
      <p id="review" class="notice" style="margin-top:10px">Review your cart. Then add your details and click <strong>Continue to payment</strong>. We’ll save your order and show payment options (Cash App, Venmo, or Cash).</p>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
        <button id="clearBtn" class="btn danger">Clear cart</button>
        <button id="toShop" class="btn">Continue shopping</button>
      </div>
    </section>

    <section>
      <div class="card" id="detailsCard">
        <div class="pad">
          <h2 style="margin:0 0 10px; font-size:18px">Your Details</h2>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <label for="oName">Full name</label>
              <input id="oName" placeholder="Jane Doe" required>
            </div>
            <div>
              <label for="oPhone">Phone</label>
              <input id="oPhone" placeholder="(555) 555-5555" required>
            </div>
          </div>
          <div style="margin-top:12px">
            <label for="oEmail">Email</label>
            <input id="oEmail" type="email" placeholder="you@example.com" required>
          </div>
		  <div style="margin-top:12px;">
			<label for="oDate">Pickup Date and Time</label>
			<input id="oDate" type="datetime-local" required>
		  </div>	
          <div style="margin-top:12px">
            <label for="oNotes">Notes (optional)</label>
            <textarea id="oNotes" rows="3" placeholder="Preferred pickup time, directions, allergies, etc."></textarea>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button id="toPayBtn" class="btn primary">Continue to payment</button>
          </div>
          <p id="sendStatus" class="notice" style="margin-top:12px; display:none"></p>
        </div>
      </div>

      <!-- Appears after successful email send -->
      <div class="card" id="paymentCard" style="display:none">
        <div class="pad" id="paymentInner"></div>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="container" style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap">
    <span><span id="year"></span> K&A Farms</span>
    <span class="muted">Private link — please don’t share publicly</span>
  </div>
</footer>

<script>
let pendingOrderPayload = null;
let emailSent = false;

// === CONFIG ===
const STORAGE_KEY = 'ka_cart';
const PRODUCTS = window.PRODUCTS;
const TOTAL_KEY   = 'ka_cart_total';
const PRICES = Object.fromEntries(
    Object.entries(PRODUCTS).map(([k,v])=>[k,v.price])
);
const TITLES = Object.fromEntries(
    Object.entries(PRODUCTS).map(([k,v])=>[k,v.title])
);
const THUMBS = Object.fromEntries(
    Object.entries(PRODUCTS).map(([k,v])=>[k,v.thumb])
);

// Payment identities
const CASH_TAG   = 'AustinBlack17';        // no $ here
const VENMO_USER = 'Austin-Black-222';  // no @ here

// === CART UTIL ===
function loadCart(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch{ return {}; } }
function saveCart(c){ localStorage.setItem(STORAGE_KEY, JSON.stringify(c)); }
function currency(n){ return (Math.round(n*100)/100).toFixed(2); }
function itemsCount(c){ return Object.values(c).reduce((a,b)=>a+(b||0),0); }
function total(c){ return Object.entries(c).reduce((s,[k,q])=> s + (PRICES[k]||0)*(q||0), 0); }

const cart = loadCart();

// Header badge
function updateBadge(){
  document.getElementById('cartCount').textContent = itemsCount(cart);
  document.getElementById('cartTotal').textContent = currency(total(cart));
}

// Order ID
function orderId(){
  const t=new Date();
  return 'KA-'+t.getFullYear().toString().slice(-2)
        +(t.getMonth()+1+'').padStart(2,'0')
        +t.getDate().toString().padStart(2,'0')
        +'-'+Math.random().toString(36).slice(2,6).toUpperCase();
}
let lastOrderId = orderId();

// Render cart lines
function render(){
  const box = document.getElementById('cartBox');
  box.innerHTML = '';

  if(itemsCount(cart) === 0){
    box.innerHTML = `<div class="empty">Your cart is empty. <a href='https://www.ka-farms.com/Shop'>Go to the shop</a>.</div>`;
    document.getElementById('grand').textContent = '0.00';
    localStorage.setItem(TOTAL_KEY, 0);
    updateBadge();
    return;
  }

  const head = document.createElement('div');
  head.className = 'row head pad';
  head.innerHTML = `<div>Item</div><div>Price</div><div>Qty</div><div>Line total</div><div></div>`;
  box.appendChild(head);

  Object.keys(cart).forEach(key => {
    const qty = cart[key]||0; if(!qty) return;
    const line = document.createElement('div');
    line.className = 'row pad';
    line.innerHTML = `
      <div class="line"><img class="thumb" src="${THUMBS[key]||''}" alt="${TITLES[key]}"><div>${TITLES[key]}</div></div>
      <div>$ ${currency(PRICES[key]||0)}</div>
      <div class="actions" data-key="${key}">
        <button class="step" aria-label="Decrease">–</button>
        <strong class="qty">${qty}</strong>
        <button class="step" aria-label="Increase">+</button>
      </div>
      <div class="money">$ <span class="lineTotal">${currency((PRICES[key]||0)*qty)}</span></div>
      <div class="actions"><button class="btn danger" data-remove>Remove</button></div>`;
    box.appendChild(line);
  });

  // +/- and remove
  box.querySelectorAll('.actions').forEach(group => {
    const key = group.dataset.key; if(!key) return;
    const dec = group.querySelectorAll('.step')[0];
    const inc = group.querySelectorAll('.step')[1];
    const qtyEl = group.querySelector('.qty');
    const lineTotalEl = group.parentElement.querySelector('.lineTotal');

    dec.addEventListener('click', ()=>{
      cart[key] = Math.max(0,(cart[key]||0)-1);
      if(cart[key]===0){ delete cart[key]; group.parentElement.remove(); }
      qtyEl.textContent = cart[key]||0;
      lineTotalEl.textContent = currency((PRICES[key]||0)*(cart[key]||0));
      finalize();
    });
    inc.addEventListener('click', ()=>{
      cart[key] = (cart[key]||0)+1;
      qtyEl.textContent = cart[key];
      lineTotalEl.textContent = currency((PRICES[key]||0)*(cart[key]||0));
      finalize();
    });
  });

  box.querySelectorAll('[data-remove]').forEach(btn => {
    btn.addEventListener('click', ()=>{
      const row = btn.closest('.row');
      const key = row.querySelector('.actions').dataset.key;
      delete cart[key];
      row.remove();
      finalize();
    });
  });

  finalize();
}

function finalize(){
  Object.keys(cart).forEach(k => { if(!cart[k]) delete cart[k]; });
  saveCart(cart);
  const g = total(cart);
  document.getElementById('grand').textContent = currency(g);
  localStorage.setItem(TOTAL_KEY, g);
  updateBadge();
}

function summaryLines(){
  return Object.entries(cart)
    .filter(([,q])=>q>0)
    .map(([k,q])=>`• ${q}× ${TITLES[k]} @ $${(PRICES[k]||0).toFixed(2)}`)
    .join('\n');
}

// ===== EMAILJS FLOW (stay on page) =====
function prettyDate(iso) {
  try { const d = new Date(iso); return d.toLocaleString([], { dateStyle:'medium', timeStyle:'short' }); }
  catch { return ''; }
}

function cartTableHTML() {
  const rows = Object.entries(cart)
    .filter(([, q]) => q > 0)
    .map(([k, q]) => {
      const unit  = (PRICES[k]||0).toFixed(2);
      const line  = (q * (PRICES[k]||0)).toFixed(2);
      return `<tr>
        <td style="padding:8px;border-top:1px solid #eee">${q}</td>
        <td style="padding:8px;border-top:1px solid #eee">${TITLES[k]}</td>
        <td style="padding:8px;border-top:1px solid #eee;text-align:right">$${unit}</td>
        <td style="padding:8px;border-top:1px solid #eee;text-align:right">$${line}</td>
      </tr>`;
    }).join('');
  if (!rows) return '';
  return `<table cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse">
    <thead>
      <tr>
        <th align="left" style="padding:8px;border-bottom:1px solid #ddd">Qty</th>
        <th align="left" style="padding:8px;border-bottom:1px solid #ddd">Item</th>
        <th align="right" style="padding:8px;border-bottom:1px solid #ddd">Unit</th>
        <th align="right" style="padding:8px;border-bottom:1px solid #ddd">Line</th>
      </tr>
    </thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function buildOrderPayload(generatedId) {
  const name   = document.getElementById('oName').value.trim();
  const email  = document.getElementById('oEmail').value.trim();
  const phone  = document.getElementById('oPhone').value.trim();
  const notes  = document.getElementById('oNotes').value.trim();
  const date   = document.getElementById('oDate').value.trim();
  const totalStr = document.getElementById('grand').textContent;

  return {
    order_id: generatedId,
    name, email, phone,
    pickup_iso: date,
    pickup_pretty: prettyDate(date),
    notes,
    items_text: Object.entries(cart)
      .filter(([, q]) => q > 0)
      .map(([k, q]) => `${q} × ${TITLES[k]} @ $${(PRICES[k]||0).toFixed(2)}`)
      .join('\n'),
    cart_table_html: cartTableHTML(),
    total: totalStr,
    created_at: new Date().toLocaleString()
  };
}


async function sendOrderEmail(payload) {
  const templateParams = {
    order_id: payload.order_id,
    name: payload.name,
    email: payload.email,
    phone: payload.phone,
    pickup_iso: payload.pickup_iso,
    pickup_pretty: payload.pickup_pretty,
    notes: payload.notes || '—',
    items_text: payload.items_text,
    cart_table_html: payload.cart_table_html,
    total: payload.total,
    created_at: payload.created_at,
    payment_method: payload.payment_method || ''
  };

  return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
}

async function handlePaymentChoice(methodLabel, afterSend) {
  if (!pendingOrderPayload) {
    alert('Something went wrong: no pending order found.');
    return;
  }

  // If we've already sent the email once, just proceed
  if (emailSent) {
    afterSend();
    return;
  }

  const statusEl = document.getElementById('sendStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = `Saving your order with payment method: ${methodLabel}…`;

  try {
    const payloadWithMethod = {
      ...pendingOrderPayload,
      payment_method: methodLabel
    };
    await sendOrderEmail(payloadWithMethod);
    emailSent = true;
    statusEl.textContent = `Order ${pendingOrderPayload.order_id} saved with payment method: ${methodLabel}.`;
    afterSend();
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Could not save your order with payment method. Please try again or email kafarmsorders@gmail.com.';
  }
}


// ===== PAYMENT SCREEN =====
function openCashAppWithTotal(total, note) {
  // Cash App cannot prefill note; we display/copy it instead
  const amount = Number(total).toFixed(2);
  const url = `https://cash.app/$${CASH_TAG}`;
  window.location.href = url;
}

function openVenmoWithTotal(total, note) {
  const amount = Number(total).toFixed(2);
  const encodedNote = encodeURIComponent(note || '');
  const url = `https://venmo.com/u/${VENMO_USER}?txn=pay&amount=${amount}&note=${encodedNote}`;
  window.location.href = url;
}

function renderPaymentScreen(orderId, customerName, payload) {
  document.getElementById('detailsCard').style.display = 'none';
  document.getElementById('review').style.display = 'none';

  const payCard = document.getElementById('paymentCard');
  const inner   = document.getElementById('paymentInner');
  const total   = document.getElementById('grand').textContent;
  const noteStr = `Order ${orderId} • ${customerName}`;

  inner.innerHTML = `
	<p class="notice" style="margin:0 0 12px">
	  Pickup: <strong>${payload.pickup_pretty}</strong><br>
	  <span class="small">Include this note with payment:</span>
	  <br>
	  <br>
	  <span class="code">${noteStr}</span>
	</p>

    <div style="display:grid; gap:10px">
      <button class="btn cashapp" id="btnCashApp">Pay with $CashApp</button>
      <button class="btn venmo" id="btnVenmo">Pay with Venmo</button>
	  <button class="btn primary" id="btnCash">Pay with Cash</button>
      <div id="thanks" class="notice" style="display:none;">
       Thank you for your order! 
	   We’ll confirm your pickup time by text/email.
      </div>
    </div>
  `;
  payCard.style.display = 'block';

document.getElementById('btnCashApp').onclick = () =>
  handlePaymentChoice('Cash App', () => openCashAppWithTotal(total, noteStr));

document.getElementById('btnVenmo').onclick = () =>
  handlePaymentChoice('Venmo', () => openVenmoWithTotal(total, noteStr));
  
document.getElementById('btnCash').onclick = () =>
	handlePaymentChoice('Cash', () => {document.getElementById('thanks').style.display = 'block'});

}

// ===== BUTTONS =====
document.getElementById('toPayBtn').addEventListener('click', ()=>{
  if (itemsCount(cart) === 0) { alert('Your cart is empty.'); return; }

  const name  = document.getElementById('oName').value.trim();
  const email = document.getElementById('oEmail').value.trim();
  const phone = document.getElementById('oPhone').value.trim();
  const date  = document.getElementById('oDate').value.trim();

  if (!name || !email || !phone) {
    alert('Please fill in your name, email, and phone.');
    return;
  }
  if (!date) {
    alert('Please choose a pickup date/time');
    return;
  }

  const id = lastOrderId;
  const payload = buildOrderPayload(id);
  pendingOrderPayload = payload;     // save for later
  emailSent = false;                 // reset flag if they come back/retry

  const statusEl = document.getElementById('sendStatus');
  statusEl.style.display = 'block';
  statusEl.textContent = 'Order details ready. Choose a payment method below to finish.';

  // Go straight to payment screen (no email yet)
  renderPaymentScreen(id, name, payload);

  // Optionally disable the details button so they don't double-start the flow
  document.getElementById('toPayBtn').disabled = true;
});


document.getElementById('clearBtn').addEventListener('click', ()=>{
  localStorage.removeItem(STORAGE_KEY);
  localStorage.setItem(TOTAL_KEY, 0);
  Object.keys(cart).forEach(k=>delete cart[k]);
  render();
});

document.getElementById('toShop').addEventListener('click', ()=>{
  window.location.href = 'K&A Farms - Shop.html';
});

// Init
render();
updateBadge();
document.getElementById('year').textContent = new Date().getFullYear();
</script>
</body>
</html>





